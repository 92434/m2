name: Image Transfer to GitHub Packages

on:
  workflow_dispatch:
    inputs:
      source_image:
        description: 'æºé•œåƒåœ°å€'
        required: false
        default: 'jiangrui1994/cloudsaver:latest'
      target_name:
        description: 'ç›®æ ‡åŒ…åç§°'
        required: false
        default: 'cloudsaver'

jobs:
  transfer:
    runs-on: ubuntu-latest
    permissions:
      packages: write
    
    steps:
      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull and Push Image
        run: |
          # æ‹‰å–æºé•œåƒ
          echo "ğŸ“¥ Pulling ${{ github.event.inputs.source_image }}"
          docker pull ${{ github.event.inputs.source_image }}
          
          # åˆ›å»ºç›®æ ‡æ ‡ç­¾
          TARGET_BASE="ghcr.io/${{ github.repository_owner }}/${{ github.event.inputs.target_name }}"
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          
          # æ ‡è®°ä¸ºlatest
          docker tag ${{ github.event.inputs.source_image }} ${TARGET_BASE}:latest
          
          # æ ‡è®°ä¸ºå¸¦æ—¶é—´æˆ³çš„ç‰ˆæœ¬
          docker tag ${{ github.event.inputs.source_image }} ${TARGET_BASE}:${TIMESTAMP}
          
          # æ¨é€é•œåƒ
          echo "ğŸš€ Pushing to GitHub Packages..."
          docker push ${TARGET_BASE}:latest
          docker push ${TARGET_BASE}:${TIMESTAMP}
          
          echo "âœ… Successfully published to GitHub Packages!"
          echo "ğŸ”— Package URL: https://github.com/${{ github.repository_owner }}?tab=packages&repo_name=${{ github.event.inputs.target_name }}"