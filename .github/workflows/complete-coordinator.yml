name: å®Œæ•´åè°ƒå·¥ä½œæµ - ä¸€åˆ†äºŒäºŒåˆ†å››

on:
  workflow_dispatch:
    inputs:
      source_image:
        description: 'æºé•œåƒåœ°å€'
        required: false
        default: 'jiangrui1994/cloudsaver:latest'
      target_name:
        description: 'ç›®æ ‡åŒ…åç§°'
        required: false
        default: 'cloudsaver'

jobs:
  # ç¬¬ä¸€å±‚ï¼šä¸»åè°ƒå™¨ï¼ˆ1ä¸ªï¼‰
  main-coordinator:
    runs-on: ubuntu-latest
    outputs:
      payload: ${{ steps.prepare-payload.outputs.payload }}
    steps:
      - name: å‡†å¤‡ä¼ é€’æ•°æ®
        id: prepare-payload
        run: |
          PAYLOAD_JSON="{\"source_image\":\"${{ github.event.inputs.source_image }}\",\"target_name\":\"${{ github.event.inputs.target_name }}\"}"
          echo "payload=$PAYLOAD_JSON" >> $GITHUB_OUTPUT
          echo "å‡†å¤‡çš„æ•°æ®: $PAYLOAD_JSON"

  # ç¬¬äºŒå±‚ï¼šä¸¤ä¸ªå¹¶è¡Œå¤„ç†æµç¨‹ï¼ˆ2ä¸ªï¼‰
  auth-and-pull:
    needs: main-coordinator
    runs-on: ubuntu-latest
    steps:
      - name: æ‰§è¡Œè®¤è¯å’Œæ‹‰å–
        run: |
          echo "ğŸ” æ‰§è¡Œè®¤è¯å’Œæ‹‰å–æµç¨‹"
          echo "æ•°æ®: ${{ needs.main-coordinator.outputs.payload }}"

  tag-and-push:
    needs: main-coordinator
    runs-on: ubuntu-latest
    steps:
      - name: æ‰§è¡Œæ ‡è®°å’Œæ¨é€
        run: |
          echo "ğŸ·ï¸ æ‰§è¡Œæ ‡è®°å’Œæ¨é€æµç¨‹"
          echo "æ•°æ®: ${{ needs.main-coordinator.outputs.payload }}"

  # ç¬¬ä¸‰å±‚ï¼šå››ä¸ªå…·ä½“æ“ä½œï¼ˆ4ä¸ªï¼‰
  authentication:
    needs: auth-and-pull
    runs-on: ubuntu-latest
    permissions:
      packages: write
    steps:
      - name: Dockeræ³¨å†Œè¡¨è®¤è¯
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

  image-pulling:
    needs: auth-and-pull
    runs-on: ubuntu-latest
    steps:
      - name: æ‹‰å–æºé•œåƒ
        run: |
          SOURCE_IMAGE="${{ fromJson(needs.main-coordinator.outputs.payload).source_image }}"
          echo "ğŸ“¥ æ‹‰å–é•œåƒ: $SOURCE_IMAGE"
          docker pull "$SOURCE_IMAGE"

  image-tagging:
    needs: tag-and-push
    runs-on: ubuntu-latest
    steps:
      - name: é‡æ–°æ ‡è®°é•œåƒ
        run: |
          SOURCE_IMAGE="${{ fromJson(needs.main-coordinator.outputs.payload).source_image }}"
          TARGET_NAME="${{ fromJson(needs.main-coordinator.outputs.payload).target_name }}"
          TARGET_BASE="ghcr.io/${{ github.repository_owner }}/$TARGET_NAME"
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          
          echo "ğŸ·ï¸ æ ‡è®°é•œåƒ"
          docker tag "$SOURCE_IMAGE" "${TARGET_BASE}:latest"
          docker tag "$SOURCE_IMAGE" "${TARGET_BASE}:${TIMESTAMP}"

  image-pushing:
    needs: [tag-and-push, authentication]
    runs-on: ubuntu-latest
    permissions:
      packages: write
    steps:
      - name: æ¨é€é•œåƒåˆ°GHCR
        run: |
          TARGET_NAME="${{ fromJson(needs.main-coordinator.outputs.payload).target_name }}"
          TARGET_BASE="ghcr.io/${{ github.repository_owner }}/$TARGET_NAME"
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          
          echo "ğŸš€ æ¨é€é•œåƒ"
          docker push "${TARGET_BASE}:latest"
          docker push "${TARGET_BASE}:${TIMESTAMP}"

  # æœ€ç»ˆæ€»ç»“
  final-summary:
    needs: [authentication, image-pulling, image-tagging, image-pushing]
    runs-on: ubuntu-latest
    steps:
      - name: å·¥ä½œæµå®Œæˆæ€»ç»“
        run: |
          echo "ğŸ‰ é•œåƒä¼ è¾“å·¥ä½œæµå®Œæˆ!"
          echo "âœ… æ‰€æœ‰æ­¥éª¤å·²æˆåŠŸæ‰§è¡Œ"
          echo "ğŸ”— è®¿é—®åœ°å€: https://github.com/${{ github.repository_owner }}?tab=packages"