name: Docker Image Export Package

on:
  workflow_dispatch:
    inputs:
      image_name:
        description: 'è¦å¯¼å‡ºçš„é•œåƒåç§°'
        required: false
        default: 'jiangrui1994/cloudsaver'
      image_tag:
        description: 'é•œåƒæ ‡ç­¾'
        required: false
        default: 'latest'
      package_name:
        description: 'å¯¼å‡ºåŒ…åç§°'
        required: false
        default: 'cloudsaver-image'

jobs:
  export:
    name: Export Docker Image
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Setup
        run: |
          sudo timedatectl set-timezone "Asia/Shanghai"

      - name: Pull and Export
        run: |
          # ç®€åŒ–çš„æ—¶é—´æˆ³ (ä»…æ—¥æœŸ)
          TS=$(date +%Y%m%d)
          
          NAME="${{ github.event.inputs.image_name }}"
          TAG="${{ github.event.inputs.image_tag }}"
          PKG="${{ github.event.inputs.package_name }}"
          
          # æ¸…ç†é•œåƒåç§°
          CLEAN=$(echo "${NAME}" | sed 's/[\/:]/_/g')
          
          # æ–‡ä»¶å
          GZ_FILE="${PKG}-${CLEAN}-${TAG}-${TS}.tar.gz"
          ZIP_FILE="${PKG}-${TS}.zip"
          
          echo "Exporting ${NAME}:${TAG}"
          echo "Files: ${GZ_FILE}, ${ZIP_FILE}"
          
          # æ‹‰å–å¹¶å¯¼å‡º
          docker pull ${NAME}:${TAG}
          docker save ${NAME}:${TAG} | gzip > ${GZ_FILE}
          
          # éªŒè¯æ–‡ä»¶
          ls -lh ${GZ_FILE}
          
          # åˆ›å»ºä¿¡æ¯æ–‡ä»¶
          echo "Image: ${NAME}:${TAG}" > info.txt
          echo "Date: $(date)" >> info.txt
          echo "Usage: docker load -i ${GZ_FILE}" >> info.txt
          
          # åˆ›å»ºåŒ…
          mkdir contents
          cp ${GZ_FILE} contents/
          cp info.txt contents/
          echo "# ${PKG} Package" > contents/README.md
          echo "Load: docker load -i ${GZ_FILE}" >> contents/README.md
          
          zip -r ${ZIP_FILE} contents/
          ls -lh ${ZIP_FILE}

      - name: Upload and Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ github.run_number }}
          name: "ðŸ“¦ ${PKG} - ${{ github.event.inputs.image_name }}:${{ github.event.inputs.image_tag }}"
          body: |
            Exported: ${{ github.event.inputs.image_name }}:${{ github.event.inputs.image_tag }}
            Date: $(date)
            
            Files:
            - ${PKG}-*.tar.gz (compressed image)
            - ${PKG}-*.zip (complete package)
            
            Usage: docker load -i *.tar.gz
          files: |
            *.zip
            *.tar.gz
          draft: false

      