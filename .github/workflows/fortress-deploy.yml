name: ðŸ° æ•°æ®è¦å¡žè‡ªåŠ¨åŒ–éƒ¨ç½²

on:
  push:
    branches: [ main, develop ]
    paths:
      - '**.py'
      - '**.sh'
      - '**.yaml'
      - '.github/workflows/**'
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      deployment_target:
        description: 'éƒ¨ç½²ç›®æ ‡çŽ¯å¢ƒ'
        required: false
        default: 'test'
        type: choice
        options:
          - test
          - staging
          - production

env:
  FORTRESS_VERSION: "1.0.0"
  DEPLOYMENT_ENV: ${{ github.event.inputs.deployment_target || 'test' }}
  PYTHON_VERSION: "3.9"

jobs:
  # ================================
  # ðŸ§ª ä»£ç è´¨é‡æ£€æŸ¥
  # ================================
  code-quality-check:
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v3
      
      - name: ðŸ è®¾ç½®PythonçŽ¯å¢ƒ
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: ðŸ“¦ å®‰è£…ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install flake8 pytest black mypy
      
      - name: ðŸ” ä»£ç é£Žæ ¼æ£€æŸ¥
        run: |
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
          flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics
      
      - name: ðŸŽ¨ ä»£ç æ ¼å¼åŒ–æ£€æŸ¥
        run: |
          black --check .
      
      - name: ðŸ” ç±»åž‹æ£€æŸ¥
        run: |
          mypy --ignore-missing-imports .

  # ================================
  # ðŸ§ª å•å…ƒæµ‹è¯•
  # ================================
  unit-tests:
    runs-on: ubuntu-latest
    needs: code-quality-check
    steps:
      - name: ðŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v3
      
      - name: ðŸ è®¾ç½®PythonçŽ¯å¢ƒ
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: ðŸ“¦ å®‰è£…æµ‹è¯•ä¾èµ–
        run: |
          pip install pytest pytest-cov pyyaml cryptography psutil
      
      - name: ðŸ§ª è¿è¡Œå•å…ƒæµ‹è¯•
        run: |
          pytest tests/ -v --cov=.
      
      - name: ðŸ“Š ä¸Šä¼ è¦†ç›–çŽ‡æŠ¥å‘Š
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage.xml
          flags: unittests
          name: codecov-umbrella

  # ================================
  # ðŸ› ï¸ æž„å»ºå’Œæ‰“åŒ…
  # ================================
  build-and-package:
    runs-on: ubuntu-latest
    needs: unit-tests
    steps:
      - name: ðŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v3
      
      - name: ðŸ“¦ åˆ›å»ºéƒ¨ç½²åŒ…
        run: |
          # åˆ›å»ºéƒ¨ç½²ç›®å½•ç»“æž„
          mkdir -p fortress-build/{bin,config,scripts}
          
          # å¤åˆ¶æ ¸å¿ƒæ–‡ä»¶
          cp fortress_guardian.py fortress-build/
          cp fortress_console.py fortress-build/bin/
          cp data_fortress_config.yaml fortress-build/config/
          cp deploy_fortress.sh fortress-build/scripts/
          cp README.md fortress-build/
          
          # è®¾ç½®æ‰§è¡Œæƒé™
          chmod +x fortress-build/fortress_guardian.py
          chmod +x fortress-build/bin/fortress_console.py
          chmod +x fortress-build/scripts/deploy_fortress.sh
          
          # åˆ›å»ºç‰ˆæœ¬æ–‡ä»¶
          echo "version: ${{ env.FORTRESS_VERSION }}" > fortress-build/version.txt
          echo "build_time: $(date -u +%Y-%m-%dT%H:%M:%SZ)" >> fortress-build/version.txt
          echo "commit_hash: ${{ github.sha }}" >> fortress-build/version.txt
          
          # æ‰“åŒ…
          tar -czf night-fortress-${{ env.FORTRESS_VERSION }}.tar.gz fortress-build/
          
          # è®¡ç®—æ ¡éªŒå’Œ
          sha256sum night-fortress-${{ env.FORTRESS_VERSION }}.tar.gz > night-fortress-${{ env.FORTRESS_VERSION }}.sha256
      
      - name: ðŸ“¤ ä¸Šä¼ æž„å»ºäº§ç‰©
        uses: actions/upload-artifact@v3
        with:
          name: fortress-package-${{ env.FORTRESS_VERSION }}
          path: |
            night-fortress-${{ env.FORTRESS_VERSION }}.tar.gz
            night-fortress-${{ env.FORTRESS_VERSION }}.sha256

  # ================================
  # ðŸš€ éƒ¨ç½²åˆ°æµ‹è¯•çŽ¯å¢ƒ
  # ================================
  deploy-test:
    runs-on: ubuntu-latest
    needs: build-and-package
    if: github.ref == 'refs/heads/main' || github.event.inputs.deployment_target == 'test'
    steps:
      - name: ðŸ“¥ ä¸‹è½½æž„å»ºäº§ç‰©
        uses: actions/download-artifact@v3
        with:
          name: fortress-package-${{ env.FORTRESS_VERSION }}
      
      - name: ðŸŽ¯ éƒ¨ç½²åˆ°æµ‹è¯•æœåŠ¡å™¨
        run: |
          echo "ðŸ“¦ éƒ¨ç½²æ•°æ®è¦å¡žåˆ°æµ‹è¯•çŽ¯å¢ƒ..."
          echo "ç‰ˆæœ¬: ${{ env.FORTRESS_VERSION }}"
          echo "çŽ¯å¢ƒ: ${{ env.DEPLOYMENT_ENV }}"
          
          # æ¨¡æ‹Ÿéƒ¨ç½²è¿‡ç¨‹
          ls -la
          tar -tzf night-fortress-${{ env.FORTRESS_VERSION }}.tar.gz
          
          # è¿™é‡Œåº”è¯¥æ·»åŠ å®žé™…çš„éƒ¨ç½²è„šæœ¬
          echo "âœ… æµ‹è¯•çŽ¯å¢ƒéƒ¨ç½²å®Œæˆ"

  # ================================
  # ðŸš€ éƒ¨ç½²åˆ°ç”Ÿäº§çŽ¯å¢ƒ
  # ================================
  deploy-production:
    runs-on: ubuntu-latest
    needs: [build-and-package, deploy-test]
    if: github.ref == 'refs/heads/main' && github.event.inputs.deployment_target == 'production'
    steps:
      - name: ðŸ“¥ ä¸‹è½½æž„å»ºäº§ç‰©
        uses: actions/download-artifact@v3
        with:
          name: fortress-package-${{ env.FORTRESS_VERSION }}
      
      - name: âš ï¸ ç”Ÿäº§çŽ¯å¢ƒå®¡æ‰¹æ£€æŸ¥
        run: |
          echo "ðŸ”’ è¯·æ±‚ç”Ÿäº§çŽ¯å¢ƒéƒ¨ç½²å®¡æ‰¹..."
          echo "ç‰ˆæœ¬: ${{ env.FORTRESS_VERSION }}"
          echo "æäº¤è€…: ${{ github.actor }}"
          echo "å˜æ›´å†…å®¹: ${{ github.event.head_commit.message }}"
          
          # æ¨¡æ‹Ÿå®¡æ‰¹æµç¨‹
          echo "âœ… ç”Ÿäº§éƒ¨ç½²å·²æ‰¹å‡†"
      
      - name: ðŸš€ éƒ¨ç½²åˆ°ç”Ÿäº§çŽ¯å¢ƒ
        run: |
          echo "ðŸš€ å¼€å§‹ç”Ÿäº§çŽ¯å¢ƒéƒ¨ç½²..."
          
          # ç”Ÿäº§çŽ¯å¢ƒéƒ¨ç½²é€»è¾‘
          echo "âœ… ç”Ÿäº§çŽ¯å¢ƒéƒ¨ç½²å®Œæˆ"
          
          # å‘é€éƒ¨ç½²é€šçŸ¥
          echo "ðŸ”” éƒ¨ç½²é€šçŸ¥å·²å‘é€"

  # ================================
  # ðŸ“Š ç”Ÿæˆéƒ¨ç½²æŠ¥å‘Š
  # ================================
  generate-report:
    runs-on: ubuntu-latest
    needs: [deploy-test, deploy-production]
    if: always()
    steps:
      - name: ðŸ“Š ç”Ÿæˆéƒ¨ç½²çŠ¶æ€æŠ¥å‘Š
        run: |
          cat > deployment-report.md << 'EOF'
          # ðŸ“‹ æ•°æ®è¦å¡žéƒ¨ç½²æŠ¥å‘Š
          
          ## éƒ¨ç½²ä¿¡æ¯
          - **ç‰ˆæœ¬**: `${{ env.FORTRESS_VERSION }}`
          - **çŽ¯å¢ƒ**: `${{ env.DEPLOYMENT_ENV }}`
          - **è§¦å‘åˆ†æ”¯**: `${{ github.ref }}`
          - **æäº¤å“ˆå¸Œ**: `${{ github.sha }}`
          - **éƒ¨ç½²æ—¶é—´**: `$(date -u +%Y-%m-%dT%H:%M:%SZ)`
          
          ## éƒ¨ç½²çŠ¶æ€
          - ä»£ç è´¨é‡æ£€æŸ¥: ${{ needs.code-quality-check.result }}
          - å•å…ƒæµ‹è¯•: ${{ needs.unit-tests.result }}
          - æž„å»ºæ‰“åŒ…: ${{ needs.build-and-package.result }}
          - æµ‹è¯•çŽ¯å¢ƒéƒ¨ç½²: ${{ needs.deploy-test.result }}
          - ç”Ÿäº§çŽ¯å¢ƒéƒ¨ç½²: ${{ needs.deploy-production.result }}
          
          ## éƒ¨ç½²è¯¦æƒ…
          éƒ¨ç½²æµç¨‹å·²å®Œæˆï¼Œç³»ç»ŸçŠ¶æ€æ­£å¸¸ã€‚
          
          ---
          *æ¥è‡ªå¤œçš„å‘½åæœ¯Â·å£¹çš„æ•°å­—å ¡åž’*
          EOF
      
      - name: ðŸ“¤ ä¸Šä¼ æŠ¥å‘Š
        uses: actions/upload-artifact@v3
        with:
          name: deployment-report
          path: deployment-report.md