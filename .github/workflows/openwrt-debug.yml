name: ğŸ› ï¸ OpenWrtæ„å»ºè°ƒè¯•ä¸ä¿®å¤

on:
  workflow_dispatch:
    inputs:
      openwrt_version:
        description: 'OpenWrtç‰ˆæœ¬åˆ†æ”¯'
        required: false
        default: 'openwrt-23.05'
      target_arch:
        description: 'ç›®æ ‡æ¶æ„'
        required: false
        default: 'x86_64'

jobs:
  debug-build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: ğŸ“‹ ç³»ç»Ÿä¿¡æ¯
        run: |
          echo "æ“ä½œç³»ç»Ÿ: $(uname -a)"
          echo "å¯ç”¨ç©ºé—´: $(df -h)"
          echo "å†…å­˜ä¿¡æ¯: $(free -h)"
      
      - name: ğŸ› ï¸ å®‰è£…æ„å»ºä¾èµ–
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential libncurses5-dev libncursesw5-dev \
            zlib1g-dev gawk git gettext libssl-dev xsltproc rsync wget \
            python3 python3-distutils
      
      - name: ğŸ“¥ å…‹éš†OpenWrtæºç 
        run: |
          git clone https://github.com/openwrt/openwrt.git
          cd openwrt
          git checkout ${{ github.event.inputs.openwrt_version }}
      
      - name: ğŸ”„ æ›´æ–°å’Œå®‰è£…feeds
        run: |
          cd openwrt
          ./scripts/feeds update -a
          ./scripts/feeds install -a
      
      - name: âš™ï¸ é…ç½®æ„å»ºç¯å¢ƒ
        run: |
          cd openwrt
          # åˆ›å»ºåŸºç¡€é…ç½®
          cat > .config << 'EOF'
          CONFIG_TARGET_x86=y
          CONFIG_TARGET_x86_64=y
          CONFIG_TARGET_x86_64_Generic=y
          CONFIG_PACKAGE_libpango=y
          CONFIG_PACKAGE_libsdl2=y
          CONFIG_PACKAGE_libsdl2-mixer=y
          # å…¶ä»–å¿…è¦åŒ…...
          EOF
          
          # æ¸…ç†å¹¶é‡æ–°é…ç½®
          make clean
          make defconfig
      
      - name: ğŸ” è¯Šæ–­é—®é¢˜åŒ…
        run: |
          cd openwrt
          echo "=== åŒ…ä¾èµ–æ£€æŸ¥ ==="
          make package/feeds/video/pango/check-package 2>&1 || echo "pangoæ£€æŸ¥å¤±è´¥"
          make package/feeds/video/sdl2/check-package 2>&1 || echo "sdl2æ£€æŸ¥å¤±è´¥"
          
          echo "=== å¯ç”¨åŒ…åˆ—è¡¨ ==="
          ./scripts/feeds list | grep -E "(pango|sdl2|video)" || echo "æœªæ‰¾åˆ°ç›¸å…³åŒ…"
      
      - name: ğŸ“Š ç”Ÿæˆè¯¦ç»†æ„å»ºæ—¥å¿—
        run: |
          cd openwrt
          echo "å¼€å§‹è¯¦ç»†æ„å»ºè¿‡ç¨‹..."
          make V=s 2>&1 | tee build.log
          
          # åˆ†æé”™è¯¯
          echo "=== é”™è¯¯åˆ†æ ==="
          grep -i "error\|failed\|collecting" build.log || echo "æœªå‘ç°æ˜æ˜¾é”™è¯¯"
          
          # ä¸Šä¼ æ—¥å¿—
          echo "ä¸Šä¼ æ„å»ºæ—¥å¿—..."
      
      - name: ğŸ“¤ ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: openwrt-debug-info
          path: |
            openwrt/build.log
            openwrt/.config
            openwrt/tmp/