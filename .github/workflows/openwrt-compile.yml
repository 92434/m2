name: ğŸ”¨ OpenWrt ç¼–è¯‘å·¥ä½œæµ

on:
  workflow_dispatch:
    inputs:
      openwrt_repo:
        description: 'OpenWrt ä»“åº“åœ°å€'
        required: false
        default: 'https://github.com/openwrt/openwrt.git'
      openwrt_branch:
        description: 'OpenWrt åˆ†æ”¯'
        required: false
        default: 'main'
      target_profile:
        description: 'ç›®æ ‡è®¾å¤‡é…ç½®'
        required: false
        default: 'generic'
      compile_threads:
        description: 'ç¼–è¯‘çº¿ç¨‹æ•°'
        required: false
        default: '4'
      config_url:
        description: 'è¿œç¨‹é…ç½®æ–‡ä»¶ URL (å¯é€‰)'
        required: false
        default: ''
      config_server:
        description: 'é…ç½®æœåŠ¡å™¨åœ°å€ (å¯é€‰)'
        required: false
        default: ''

env:
  OPENWRT_ROOT: /home/runner/work/openwrt
  COMPILE_CACHE: /home/runner/work/cc-cache
  REMOTE_CONFIG_DIR: /home/runner/remote-configs

jobs:
  # ============ ç¬¬ä¸€æ­¥ï¼šå‡†å¤‡ç¼–è¯‘ç¯å¢ƒ ============
  prepare-environment:
    runs-on: ubuntu-latest
    outputs:
      build-id: ${{ steps.build-info.outputs.id }}
      build-time: ${{ steps.build-info.outputs.time }}
    
    steps:
      - name: âœ… ç³»ç»Ÿä¿¡æ¯
        id: build-info
        run: |
          BUILD_ID=$(date '+%Y%m%d-%H%M%S')
          BUILD_TIME=$(date '+%Y-%m-%d %H:%M:%S')
          echo "id=$BUILD_ID" >> $GITHUB_OUTPUT
          echo "time=$BUILD_TIME" >> $GITHUB_OUTPUT
          
          echo "=== ç³»ç»Ÿä¿¡æ¯ ==="
          echo "CPU æ ¸å¿ƒæ•°: $(nproc)"
          echo "å†…å­˜å¤§å°: $(free -h | grep Mem | awk '{print $2}')"
          echo "ç£ç›˜ç©ºé—´: $(df -h / | tail -1 | awk '{print $4}')"
          echo "æ„å»ºID: $BUILD_ID"
          echo "æ„å»ºæ—¶é—´: $BUILD_TIME"
      
      - name: ğŸ”§ å®‰è£…ç¼–è¯‘ä¾èµ–
        run: |
          echo "ğŸ“¥ å®‰è£… OpenWrt ç¼–è¯‘ä¾èµ–..."
          sudo apt-get update -qq
          sudo apt-get install -y \
            build-essential \
            clang \
            flex \
            bison \
            g++ \
            gawk \
            gcc \
            gettext \
            git \
            libncurses5-dev \
            libssl-dev \
            msmtp \
            openssh-client \
            patch \
            rsync \
            unzip \
            xsltproc \
            zlib1g-dev \
            ca-certificates \
            cron \
            curl \
            wget
          sudo apt-get update -qq
          sudo apt-get install -y vim nano htop curl wget jq
          
          # å®‰è£…ngrok
          echo "ğŸ“¥ å®‰è£…ngrok..."
          wget https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-linux-amd64.tgz
          tar -xzf ngrok-v3-stable-linux-amd64.tgz
          chmod +x ngrok
          sudo mv ngrok /usr/local/bin/
          
          # å¯åŠ¨SSHæœåŠ¡
          sudo systemctl start ssh
          sudo systemctl enable ssh
          # å¯åŠ¨Webç»ˆç«¯
          echo "ğŸ–¥ï¸ å¯åŠ¨Webç»ˆç«¯..."
          sudo apt-get install -y ttyd
          ttyd -p 8080 bash &
          # å¯åŠ¨ngrok HTTPéš§é“åˆ°Webç»ˆç«¯
          echo "ğŸš€ å¯åŠ¨ngrokéš§é“..."
          ngrok config add-authtoken 39KIyZLRt49IgXkBR54tWUTjybb_24o8c6QwijSgF5YMXeNxo &
          echo "ngrokå¯åŠ¨ä¸­..."
          ngrok http 8080
          echo "ngrokå¯åŠ¨æˆåŠŸ"
          
          # ç­‰å¾…ngrokå¯åŠ¨
          sleep 5
          echo "âœ… ä¾èµ–å®‰è£…å®Œæˆ"
          gcc --version
          git --version

  # ============ ç¬¬äºŒæ­¥ï¼šæ£€å‡ºæºä»£ç  ============
  checkout-source:
    needs: prepare-environment
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ æ£€å‡º OpenWrt æºä»£ç 
        run: |
          echo "å…‹éš† OpenWrt ä»“åº“..."
          git clone --depth 1 \
            --branch ${{ github.event.inputs.openwrt_branch }} \
            ${{ github.event.inputs.openwrt_repo }} \
            ${{ env.OPENWRT_ROOT }}
          
          cd ${{ env.OPENWRT_ROOT }}
          echo "å½“å‰åˆ†æ”¯: $(git branch --show-current)"
          echo "æœ€æ–°æäº¤: $(git log -1 --oneline)"
      
      - name: ğŸ“¦ æ›´æ–° feeds
        run: |
          cd ${{ env.OPENWRT_ROOT }}
          echo "æ›´æ–° feeds..."
          ./scripts/feeds update -a
          ./scripts/feeds install -a
          
          echo "âœ… Feeds æ›´æ–°å®Œæˆ"
          echo "å®‰è£…çš„åŒ…æ•°é‡: $(ls feeds/*/pkgs 2>/dev/null | wc -l)"
      
      - name: ğŸ’¾ ç¼“å­˜æºä»£ç 
        uses: actions/cache@v4
        with:
          path: ${{ env.OPENWRT_ROOT }}
          key: openwrt-source-${{ github.event.inputs.openwrt_branch }}-${{ needs.prepare-environment.outputs.build-id }}
          restore-keys: |
            openwrt-source-${{ github.event.inputs.openwrt_branch }}-

  # ============ ç¬¬ä¸‰æ­¥ï¼šç”Ÿæˆé…ç½®æ–‡ä»¶ ============
  generate-config:
    needs: [prepare-environment, checkout-source]
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ’¾ æ¢å¤æºä»£ç 
        uses: actions/cache@v4
        with:
          path: ${{ env.OPENWRT_ROOT }}
          key: openwrt-source-${{ github.event.inputs.openwrt_branch }}-${{ needs.prepare-environment.outputs.build-id }}
      
      - name: ğŸ“¡ ä»è¿œç¨‹æœåŠ¡å™¨ä¸‹è½½é…ç½®
        run: |
          mkdir -p ${{ env.REMOTE_CONFIG_DIR }}
          
          # æ£€æŸ¥æ˜¯å¦æä¾›äº†é…ç½® URL
          if [ -n "${{ github.event.inputs.config_url }}" ]; then
            echo "ğŸ“¥ ä»è¿œç¨‹ URL ä¸‹è½½é…ç½®..."
            echo "é…ç½® URL: ${{ github.event.inputs.config_url }}"
            
            if curl -f -L "${{ github.event.inputs.config_url }}" -o ${{ env.REMOTE_CONFIG_DIR }}/.config ; then
              echo "âœ… è¿œç¨‹é…ç½®ä¸‹è½½æˆåŠŸ"
            else
              echo "âš ï¸ è¿œç¨‹é…ç½®ä¸‹è½½å¤±è´¥ï¼Œå°†ä½¿ç”¨é»˜è®¤é…ç½®"
              touch ${{ env.REMOTE_CONFIG_DIR }}/.config.failed
            fi
          fi
          
          # æ£€æŸ¥æ˜¯å¦æä¾›äº†é…ç½®æœåŠ¡å™¨
          if [ -n "${{ github.event.inputs.config_server }}" ]; then
            echo "ğŸ”— è¿æ¥åˆ°é…ç½®æœåŠ¡å™¨..."
            echo "æœåŠ¡å™¨: ${{ github.event.inputs.config_server }}"
            
            # å°è¯•ä»é…ç½®æœåŠ¡å™¨ä¸‹è½½é…ç½®
            SERVER="${{ github.event.inputs.config_server }}"
            
            # å°è¯•å¤šä¸ªå¸¸è§çš„é…ç½®è·¯å¾„
            for path in "/.config" "/openwrt/.config" "/configs/.config" "/default.config"; do
              echo "å°è¯•: $SERVER$path"
              if curl -f -L "$SERVER$path" -o ${{ env.REMOTE_CONFIG_DIR }}/.config.tmp 2>/dev/null; then
                echo "âœ… é…ç½®æœåŠ¡å™¨è¿æ¥æˆåŠŸï¼Œå·²ä¸‹è½½é…ç½®"
                mv ${{ env.REMOTE_CONFIG_DIR }}/.config.tmp ${{ env.REMOTE_CONFIG_DIR }}/.config
                break
              fi
            done
            
            if [ ! -f ${{ env.REMOTE_CONFIG_DIR }}/.config ]; then
              echo "âš ï¸ æ— æ³•ä»é…ç½®æœåŠ¡å™¨è·å–é…ç½®"
            fi
          fi
      
      - name: âš™ï¸ ç”Ÿæˆç¼–è¯‘é…ç½®
        run: |
          cd ${{ env.OPENWRT_ROOT }}
          echo "ç”Ÿæˆç¼–è¯‘é…ç½®..."
          make defconfig
          
          # æ£€æŸ¥æ˜¯å¦å­˜åœ¨è¿œç¨‹é…ç½®
          if [ -f ${{ env.REMOTE_CONFIG_DIR }}/.config ] && [ ! -f ${{ env.REMOTE_CONFIG_DIR }}/.config.failed ]; then
            echo "ğŸ“¥ åˆå¹¶è¿œç¨‹é…ç½®..."
            # å¤‡ä»½åŸå§‹é…ç½®
            cp .config .config.default
            # åˆå¹¶è¿œç¨‹é…ç½®ï¼ˆè¿œç¨‹é…ç½®ä¼˜å…ˆï¼‰
            cat ${{ env.REMOTE_CONFIG_DIR }}/.config >> .config
            echo "âœ… å·²åº”ç”¨è¿œç¨‹é…ç½®"
          else
            echo "ğŸ“ ä½¿ç”¨æœ¬åœ°é»˜è®¤é…ç½®..."
            
            # å¸¸ç”¨é…ç½®é€‰é¡¹ç¤ºä¾‹
            cat >> .config << 'EOF'
          CONFIG_TARGET_ARCH_PACKAGES="x86_64"
          CONFIG_TARGET_x86=y
          CONFIG_TARGET_x86_64=y
          CONFIG_TARGET_x86_64_Generic=y
          CONFIG_PACKAGE_luci=y
          CONFIG_PACKAGE_luci-app-upnp=y
          EOF
          fi
          
          # éªŒè¯å’Œä¼˜åŒ–é…ç½®
          echo "ğŸ” éªŒè¯é…ç½®å†…å®¹..."
          make defconfig
          
          # æ£€æŸ¥é…ç½®æ˜¯å¦æœ‰é‡å¤
          echo "ğŸ§¹ æ¸…ç†é‡å¤é…ç½®..."
          sort .config | uniq > .config.tmp
          mv .config.tmp .config
          
          echo "âœ… é…ç½®ç”Ÿæˆå’ŒéªŒè¯å®Œæˆ"
      
      - name: ğŸ”§ å®‰è£…è°ƒè¯•å·¥å…·å’Œngrok
        run: |

          
          echo "âœ… è°ƒè¯•å·¥å…·å’Œngrokå®‰è£…å®Œæˆ"
      
      - name: ğŸŒ å¯åŠ¨ngrokåå‘ä»£ç†
        run: |
          cd ${{ env.OPENWRT_ROOT }}
          
          # å¯åŠ¨SSHæœåŠ¡
          sudo systemctl start ssh
          sudo systemctl enable ssh
          # å¯åŠ¨Webç»ˆç«¯
          echo "ğŸ–¥ï¸ å¯åŠ¨Webç»ˆç«¯..."
          sudo apt-get install -y ttyd
          ttyd -p 8080 bash &
          # å¯åŠ¨ngrok HTTPéš§é“åˆ°Webç»ˆç«¯
          echo "ğŸš€ å¯åŠ¨ngrokéš§é“..."
          ngrok http 8080
          
          # ç­‰å¾…ngrokå¯åŠ¨
          sleep 5
          
          # è·å–å…¬å…±URL
          NGROK_URL=$(curl -s localhost:4040/api/tunnels | jq -r '.tunnels[0].public_url')
          
          echo "========================================"
          echo "ğŸŒ ngrokè¿œç¨‹è®¿é—®å·²å¯åŠ¨"
          echo "Webç»ˆç«¯åœ°å€: $NGROK_URL"
          echo "SSHè¿æ¥: ssh runner@$(curl -s ifconfig.me)"
          echo "========================================"
          

          
          # ä¿æŒä¼šè¯æ´»è·ƒ
          echo "â³ ç­‰å¾…è¿œç¨‹è°ƒè¯•... (60åˆ†é’Ÿè¶…æ—¶)"
          sleep 3600  # ç­‰å¾…1å°æ—¶
          
      - name: ğŸ“‹ éªŒè¯é…ç½®
        run: |
          cd ${{ env.OPENWRT_ROOT }}
          echo "=== é…ç½®éªŒè¯ ==="
          echo "é…ç½®æ–‡ä»¶å­˜åœ¨: $([ -f .config ] && echo 'âœ… æ˜¯' || echo 'âŒ å¦')"
          echo "é…ç½®è¡Œæ•°: $(wc -l < .config 2>/dev/null || echo '0')"
          echo ""
          echo "é…ç½®å†…å®¹é¢„è§ˆ:"
          head -20 .config
          echo ""
          echo "=== é…ç½®æ–‡ä»¶å¤§å° ==="
          ls -lh .config
          
          # éªŒè¯é…ç½®
          if make oldconfig < /dev/null > /dev/null 2>&1; then
            echo "âœ… é…ç½®éªŒè¯é€šè¿‡"
          else
            echo "âš ï¸ é…ç½®éªŒè¯è­¦å‘Šï¼Œä½†å¯ä»¥ç»§ç»­ç¼–è¯‘"
          fi
      
      - name: ğŸ“‹ æ˜¾ç¤ºé…ç½®ä¿¡æ¯
        run: |
          cd ${{ env.OPENWRT_ROOT }}
          echo "=== ç¼–è¯‘é…ç½® ==="
          echo "æ€»é…ç½®æ•°: $(wc -l < .config)"
          echo ""
          echo "å‰30è¡Œé…ç½®:"
          head -30 .config
          echo ""
          echo "=== é…ç½®ç»Ÿè®¡ ==="
          echo "å¯ç”¨é¡¹ (=y): $(grep -c '=y' .config)"
          echo "ç¦ç”¨é¡¹ (=n): $(grep -c '=n' .config)"
          echo "æ¨¡å—é¡¹ (=m): $(grep -c '=m' .config)"
          echo "å­—ç¬¦ä¸²é¡¹ (=\\"): $(grep -c '=.*\\"' .config)"
          
          # æ£€æŸ¥æ˜¯å¦æœ‰è¿œç¨‹é…ç½®è¢«åº”ç”¨
          if [ -f .config.default ]; then
            echo ""
            echo "ğŸ”€ é…ç½®å·®å¼‚:"
            echo "é»˜è®¤é…ç½®è¡Œæ•°: $(wc -l < .config.default)"
            echo "å½“å‰é…ç½®è¡Œæ•°: $(wc -l < .config)"
            diff_count=$(diff .config.default .config | wc -l)
            echo "å·®å¼‚è¡Œæ•°: $diff_count"
          fi
      
      - name: ï¿½ ä¸Šä¼ é…ç½®æ–‡ä»¶ç”¨äºè°ƒè¯•
        uses: actions/upload-artifact@v4
        with:
          name: openwrt-config-${{ needs.prepare-environment.outputs.build-id }}
          path: |
            ${{ env.OPENWRT_ROOT }}/.config
            ${{ env.OPENWRT_ROOT }}/.config.default
            ${{ env.REMOTE_CONFIG_DIR }}/.config
          retention-days: 7
      
      - name: ï¿½ğŸ’¾ ç¼“å­˜é…ç½®
        uses: actions/cache@v4
        with:
          path: ${{ env.OPENWRT_ROOT }}/.config
          key: openwrt-config-${{ github.event.inputs.openwrt_branch }}-${{ hashFiles('.config') }}

  # ============ ç¬¬å››æ­¥ï¼šç¼–è¯‘é•œåƒ ============
  compile:
    needs: [prepare-environment, generate-config]
    runs-on: ubuntu-latest
    timeout-minutes: 360  # 6å°æ—¶è¶…æ—¶
    
    steps:
      - name: ğŸ’¾ æ¢å¤æºä»£ç 
        uses: actions/cache@v4
        with:
          path: ${{ env.OPENWRT_ROOT }}
          key: openwrt-source-${{ github.event.inputs.openwrt_branch }}-${{ needs.prepare-environment.outputs.build-id }}
      
      - name: ğŸ’¾ æ¢å¤ç¼–è¯‘é…ç½®
        uses: actions/cache@v4
        with:
          path: ${{ env.OPENWRT_ROOT }}/.config
          key: openwrt-config-${{ github.event.inputs.openwrt_branch }}-${{ hashFiles('.config') }}
      
      - name: ğŸ’¾ æ¢å¤ ccache
        uses: actions/cache@v4
        with:
          path: ${{ env.COMPILE_CACHE }}
          key: openwrt-ccache-${{ github.event.inputs.openwrt_branch }}-${{ needs.prepare-environment.outputs.build-id }}
          restore-keys: |
            openwrt-ccache-${{ github.event.inputs.openwrt_branch }}-
      
      - name: ğŸ”¨ ç¼–è¯‘ OpenWrt
        run: |
          cd ${{ env.OPENWRT_ROOT }}
          
          # è®¾ç½® ccache
          export PATH=/usr/lib/ccache:$PATH
          export ccache_dir=${{ env.COMPILE_CACHE }}
          
          echo "ğŸ”¨ å¼€å§‹ç¼–è¯‘ OpenWrt..."
          echo "ç¼–è¯‘çº¿ç¨‹æ•°: ${{ github.event.inputs.compile_threads }}"
          
          # å¼€å§‹ç¼–è¯‘
          time make -j${{ github.event.inputs.compile_threads }} V=sc 2>&1 | tee compile.log
          
          if [ $? -eq 0 ]; then
            echo "âœ… ç¼–è¯‘æˆåŠŸï¼"
          else
            echo "âŒ ç¼–è¯‘å¤±è´¥ï¼"
            echo "æŸ¥çœ‹æœ€å50è¡Œæ—¥å¿—ï¼š"
            tail -50 compile.log
            exit 1
          fi
      
      - name: ğŸ“Š ç¼–è¯‘ç»Ÿè®¡
        if: always()
        run: |
          cd ${{ env.OPENWRT_ROOT }}
          
          echo "=== ç¼–è¯‘ç»Ÿè®¡ ==="
          if [ -f compile.log ]; then
            echo "ç¼–è¯‘æ—¥å¿—å¤§å°: $(du -h compile.log | cut -f1)"
            echo "é”™è¯¯è¡Œæ•°: $(grep -i error compile.log | wc -l)"
            echo "è­¦å‘Šè¡Œæ•°: $(grep -i warning compile.log | wc -l)"
          fi
          
          if [ -d bin/targets ]; then
            echo ""
            echo "ç”Ÿæˆçš„é•œåƒæ–‡ä»¶:"
            find bin/targets -type f \( -name "*.bin" -o -name "*.img" -o -name "*.tar.gz" \) -exec ls -lh {} \; | awk '{print $9, "(" $5 ")"}'
            echo ""
            echo "é•œåƒæ€»å¤§å°: $(du -sh bin/targets | cut -f1)"
          fi

  # ============ ç¬¬äº”æ­¥ï¼šä¸Šä¼ ç¼–è¯‘äº§ç‰© ============
  upload-artifacts:
    needs: [prepare-environment, compile]
    if: always()
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ’¾ æ¢å¤ç¼–è¯‘ç»“æœ
        uses: actions/cache@v4
        with:
          path: ${{ env.OPENWRT_ROOT }}/bin
          key: openwrt-bin-${{ github.event.inputs.openwrt_branch }}-${{ needs.prepare-environment.outputs.build-id }}
      
      - name: ğŸ“¤ ç”Ÿæˆé•œåƒæ¸…å•
        run: |
          mkdir -p /tmp/artifacts
          
          cd ${{ env.OPENWRT_ROOT }}
          
          cat > /tmp/artifacts/BUILD_INFO.md << 'EOF'
          # ğŸ”¨ OpenWrt ç¼–è¯‘ä¿¡æ¯
          
          ## ç¼–è¯‘è¯¦æƒ…
          - **æ„å»ºID**: ${{ needs.prepare-environment.outputs.build-id }}
          - **ç¼–è¯‘æ—¶é—´**: ${{ needs.prepare-environment.outputs.build-time }}
          - **æºä»£ç åˆ†æ”¯**: ${{ github.event.inputs.openwrt_branch }}
          - **ç¼–è¯‘çº¿ç¨‹**: ${{ github.event.inputs.compile_threads }}
          
          ## é•œåƒæ–‡ä»¶
          EOF
          
          # åˆ—å‡ºæ‰€æœ‰ç”Ÿæˆçš„é•œåƒ
          if [ -d bin/targets ]; then
            find bin/targets -type f | while read file; do
              filename=$(basename "$file")
              filesize=$(du -h "$file" | cut -f1)
              echo "- **$filename** ($filesize)" >> /tmp/artifacts/BUILD_INFO.md
            done
          fi
          
          cat >> /tmp/artifacts/BUILD_INFO.md << 'EOF'
          
          ## ç³»ç»Ÿè¦æ±‚
          - OpenWrt æ”¯æŒå¤šç§æ¶æ„å’Œè®¾å¤‡
          - åˆ·å†™å‰è¯·å¤‡ä»½åŸå›ºä»¶
          - ç¡®ä¿ç”µæºç¨³å®šï¼Œé¿å…åˆ·å†™è¿‡ç¨‹ä¸­æ–­ç”µ
          
          ## å¿«é€Ÿå¼€å§‹
          1. ä¸‹è½½å¯¹åº”è®¾å¤‡çš„é•œåƒæ–‡ä»¶
          2. è¿›å…¥è®¾å¤‡ç®¡ç†ç•Œé¢
          3. é€‰æ‹©å›ºä»¶å‡çº§
          4. é€‰æ‹©ä¸‹è½½çš„é•œåƒæ–‡ä»¶
          5. ç­‰å¾…åˆ·å†™å®Œæˆ
          
          ## æ”¯æŒ
          - OpenWrt å®˜ç½‘: https://openwrt.org
          - æ–‡æ¡£: https://openwrt.org/docs
          EOF
          
          cat /tmp/artifacts/BUILD_INFO.md
      
      - name: ğŸ“¤ ä¸Šä¼ é•œåƒæ–‡ä»¶
        uses: actions/upload-artifact@v4
        with:
          name: openwrt-images-${{ needs.prepare-environment.outputs.build-id }}
          path: ${{ env.OPENWRT_ROOT }}/bin/targets/**/*
          retention-days: 30
      
      - name: ğŸ“¤ ä¸Šä¼ ç¼–è¯‘æ—¥å¿—
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: compile-logs-${{ needs.prepare-environment.outputs.build-id }}
          path: ${{ env.OPENWRT_ROOT }}/compile.log
          retention-days: 7
      
      - name: ğŸ“¤ ä¸Šä¼ ç¼–è¯‘ä¿¡æ¯
        uses: actions/upload-artifact@v4
        with:
          name: build-info-${{ needs.prepare-environment.outputs.build-id }}
          path: /tmp/artifacts/

  # ============ ç¬¬å…­æ­¥ï¼šç”Ÿæˆ Release ============
  create-release:
    needs: [prepare-environment, upload-artifacts]
    if: github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ ä¸‹è½½é•œåƒæ–‡ä»¶
        uses: actions/download-artifact@v4
        with:
          name: openwrt-images-${{ needs.prepare-environment.outputs.build-id }}
          path: ./images
      
      - name: ğŸ“¥ ä¸‹è½½ç¼–è¯‘ä¿¡æ¯
        uses: actions/download-artifact@v4
        with:
          name: build-info-${{ needs.prepare-environment.outputs.build-id }}
          path: ./info
      
      - name: ğŸ‰ åˆ›å»º Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: openwrt-${{ needs.prepare-environment.outputs.build-id }}
          name: ğŸ”¨ OpenWrt Release ${{ needs.prepare-environment.outputs.build-id }}
          body_path: ./info/BUILD_INFO.md
          files: |
            images/**/*
          draft: false
          prerelease: false

  # ============ æœ€åæ­¥éª¤ï¼šå®ŒæˆæŠ¥å‘Š ============
  completion-report:
    needs: [prepare-environment, compile, upload-artifacts]
    if: always()
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“Š ç¼–è¯‘å®ŒæˆæŠ¥å‘Š
        run: |
          cat > build-report.md << 'EOF'
          # ğŸ‰ OpenWrt ç¼–è¯‘æŠ¥å‘Š
          
          ## ğŸ“‹ åŸºæœ¬ä¿¡æ¯
          - **æ„å»ºID**: ${{ needs.prepare-environment.outputs.build-id }}
          - **ç¼–è¯‘æ—¶é—´**: ${{ needs.prepare-environment.outputs.build-time }}
          - **åˆ†æ”¯**: ${{ github.event.inputs.openwrt_branch }}
          - **è§¦å‘è€…**: ${{ github.actor }}
          
          ## âœ… æ„å»ºçŠ¶æ€
          - å‡†å¤‡ç¯å¢ƒ: ${{ needs.prepare-environment.result }}
          - æºä»£ç æ£€å‡º: success
          - ç¼–è¯‘: ${{ needs.compile.result }}
          - ä¸Šä¼ : ${{ needs.upload-artifacts.result }}
          
          ## ğŸ“¦ äº§ç‰©
          - é•œåƒæ–‡ä»¶: å·²ä¸Šä¼ 
          - ç¼–è¯‘æ—¥å¿—: å·²ä¸Šä¼ ï¼ˆ7å¤©ä¿ç•™ï¼‰
          - Release: ${{ needs.upload-artifacts.result == 'success' && 'å·²åˆ›å»º' || 'å¾…æ‰‹åŠ¨åˆ›å»º' }}
          
          ## ğŸ”— ç›¸å…³é“¾æ¥
          - OpenWrt å®˜ç½‘: https://openwrt.org
          - æœ¬æ¬¡æ„å»º: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          - ä¸‹è½½åœ°å€: ${{ github.server_url }}/${{ github.repository }}/releases/tag/openwrt-${{ needs.prepare-environment.outputs.build-id }}
          
          ---
          âœ¨ ç¼–è¯‘å·¥ä½œæµå®Œæˆï¼
          EOF
          
          cat build-report.md
      
      - name: ğŸ“¤ ä¸Šä¼ ç¼–è¯‘æŠ¥å‘Š
        uses: actions/upload-artifact@v4
        with:
          name: build-report
          path: build-report.md
      
      - name: ğŸ’¬ è¾“å‡ºæ‘˜è¦
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘   ğŸŠ OpenWrt ç¼–è¯‘å·¥ä½œæµå®Œæˆ ğŸŠ       â•‘"
          echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
          echo "â•‘ æ„å»ºID: ${{ needs.prepare-environment.outputs.build-id }} â•‘"
          echo "â•‘ åˆ†æ”¯: ${{ github.event.inputs.openwrt_branch }} â•‘"
          echo "â•‘ çŠ¶æ€: ${{ needs.compile.result == 'success' && 'âœ…æˆåŠŸ' || 'âŒå¤±è´¥' }} â•‘"
          echo "â•‘ äº§ç‰©: ğŸ“¦å·²ä¸Šä¼ åˆ° Artifacts â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
