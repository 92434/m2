name: ğŸ”¨ OpenWrt ç¼–è¯‘å·¥ä½œæµ

on:
  workflow_dispatch:
    inputs:
      openwrt_repo:
        description: 'OpenWrt ä»“åº“åœ°å€'
        required: false
        default: 'https://github.com/openwrt/openwrt.git'
      openwrt_branch:
        description: 'OpenWrt åˆ†æ”¯'
        required: false
        default: 'main'
      target_profile:
        description: 'ç›®æ ‡è®¾å¤‡é…ç½®'
        required: false
        default: 'generic'
      compile_threads:
        description: 'ç¼–è¯‘çº¿ç¨‹æ•°'
        required: false
        default: '4'
      config_url:
        description: 'è¿œç¨‹é…ç½®æ–‡ä»¶ URL (å¯é€‰)'
        required: false
        default: ''
      config_server:
        description: 'é…ç½®æœåŠ¡å™¨åœ°å€ (å¯é€‰)'
        required: false
        default: ''

env:
  OPENWRT_ROOT: /home/runner/work/openwrt
  COMPILE_CACHE: /home/runner/work/cc-cache
  REMOTE_CONFIG_DIR: /home/runner/remote-configs

jobs:
  # ============ ç¬¬ä¸€æ­¥ï¼šå‡†å¤‡ç¼–è¯‘ç¯å¢ƒ ============
  prepare-environment:
    runs-on: ubuntu-latest
    outputs:
      build-id: ${{ steps.build-info.outputs.id }}
      build-time: ${{ steps.build-info.outputs.time }}
    
    steps:
      - name: âœ… ç³»ç»Ÿä¿¡æ¯
        id: build-info
        run: |
          BUILD_ID=$(date '+%Y%m%d-%H%M%S')
          BUILD_TIME=$(date '+%Y-%m-%d %H:%M:%S')
          echo "id=$BUILD_ID" >> $GITHUB_OUTPUT
          echo "time=$BUILD_TIME" >> $GITHUB_OUTPUT
          
          echo "=== ç³»ç»Ÿä¿¡æ¯ ==="
          echo "CPU æ ¸å¿ƒæ•°: $(nproc)"
          echo "å†…å­˜å¤§å°: $(free -h | grep Mem | awk '{print $2}')"
          echo "ç£ç›˜ç©ºé—´: $(df -h / | tail -1 | awk '{print $4}')"
          echo "æ„å»ºID: $BUILD_ID"
          echo "æ„å»ºæ—¶é—´: $BUILD_TIME"
      
      - name: ğŸ”§ å®‰è£…ç¼–è¯‘ä¾èµ–
        run: |
          echo "ğŸ“¥ å®‰è£… OpenWrt ç¼–è¯‘ä¾èµ–..."
          sudo apt-get update -qq
          sudo apt-get install -y \
            build-essential \
            clang \
            flex \
            bison \
            g++ \
            gawk \
            gcc \
            gettext \
            git \
            libncurses5-dev \
            libssl-dev \
            msmtp \
            openssh-client \
            patch \
            rsync \
            unzip \
            xsltproc \
            zlib1g-dev \
            ca-certificates \
            cron \
            curl \
            wget
          sudo apt-get update -qq
          sudo apt-get install -y vim nano htop curl wget jq
          
          # å®‰è£…ngrok
          echo "ğŸ“¥ å®‰è£…ngrok..."
          wget https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-linux-amd64.tgz
          tar -xzf ngrok-v3-stable-linux-amd64.tgz
          chmod +x ngrok
          sudo mv ngrok /usr/local/bin/
          
          # å¯åŠ¨SSHæœåŠ¡
          sudo systemctl start ssh
          sudo systemctl enable ssh
          # å¯åŠ¨Webç»ˆç«¯
          echo "ğŸ–¥ï¸ å¯åŠ¨Webç»ˆç«¯..."
          sudo apt-get install -y ttyd
          ttyd -p 8080 bash &
          # å¯åŠ¨ngrok HTTPéš§é“åˆ°Webç»ˆç«¯
          echo "ğŸš€ å¯åŠ¨ngrokéš§é“..."
          ngrok config add-authtoken 39KIyZLRt49IgXkBR54tWUTjybb_24o8c6QwijSgF5YMXeNxo &
          echo "ngrokå¯åŠ¨ä¸­..."
          ngrok tcp 8080 > /tmp/ngrok.log 2>&1 &
          echo "ngrokå¯åŠ¨æˆåŠŸ"
          
          # ç­‰å¾…ngrokå¯åŠ¨
          sleep 1000
          echo "over"
          gcc --version
          git --version
