name: Tar Image Export

on:
  workflow_dispatch:
    inputs:
      image:
        description: 'é•œåƒåç§°:tag'
        required: false
        default: 'jiangrui1994/cloudsaver:latest'
      filename:
        description: 'è¾“å‡ºæ–‡ä»¶å(ä¸å«æ‰©å±•å)'
        required: false
        default: 'cloudsaver-image'

jobs:
  export:
    name: Export to Tar
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Export Docker Image to Tar
        run: |
          IMAGE="${{ github.event.inputs.image }}"
          FILENAME="${{ github.event.inputs.filename }}"
          DATE=$(date +%Y%m%d)
          
          echo "ðŸ“¦ Exporting ${IMAGE} to tar format"
          
          # æ‹‰å–é•œåƒ
          docker pull ${IMAGE}
          
          # å¯¼å‡ºä¸ºtaræ–‡ä»¶
          TAR_FILE="${FILENAME}-${DATE}.tar"
          echo "Creating ${TAR_FILE}"
          docker save ${IMAGE} -o ${TAR_FILE}
          
          # æ˜¾ç¤ºæ–‡ä»¶ä¿¡æ¯
          ls -lh ${TAR_FILE}
          echo "Size: $(du -h ${TAR_FILE} | cut -f1)"
          
          # åˆ›å»ºåŸºæœ¬ä¿¡æ¯æ–‡ä»¶
          echo "Docker Image Export Info" > info.txt
          echo "========================" >> info.txt
          echo "Image: ${IMAGE}" >> info.txt
          echo "File: ${TAR_FILE}" >> info.txt
          echo "Date: $(date)" >> info.txt
          echo "Size: $(du -h ${TAR_FILE} | cut -f1)" >> info.txt
          echo "" >> info.txt
          echo "Usage:" >> info.txt
          echo "docker load -i ${TAR_FILE}" >> info.txt
          
          ls -la

      - name: Upload Tar File
        uses: actions/upload-artifact@v4
        with:
          name: tar-image-export
          path: |
            *.tar
            info.txt
          retention-days: 30

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: tar-${{ github.run_number }}
          name: "ðŸ“¦ Tar Image Export - ${{ github.event.inputs.image }}"
          body: |
            ## Docker Image Tar Export
            
            Exported image: `${{ github.event.inputs.image }}`
            
            ### Files Included
            - `${{ github.event.inputs.filename }}-*.tar` - Docker image tar file
            - `info.txt` - Export information and usage instructions
            
            ### Usage Instructions
            ```bash
            # Load the image
            docker load -i ${{ github.event.inputs.filename }}-*.tar
            
            # Verify the image
            docker images | grep cloudsaver
            ```
            
            Export completed on: $(date)
          files: |
            *.tar
          draft: false
          prerelease: false