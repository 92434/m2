name: Docker Image Publish to GitHub Packages

on:
  workflow_dispatch:
    inputs:
      image_tag:
        description: 'ç›®æ ‡é•œåƒæ ‡ç­¾'
        required: false
        default: 'latest'
      registry_package_name:
        description: 'GitHub Packagesä¸­çš„åŒ…å'
        required: false
        default: 'cloudsaver'

jobs:
  publish:
    name: ğŸ³ Publish Docker Image to GitHub Packages
    runs-on: ubuntu-latest
    
    permissions:
      packages: write
      contents: read

    steps:
      - name: â±ï¸ Set timezone
        run: sudo timedatectl set-timezone "Asia/Shanghai"

      - name: ğŸ“¦ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ³ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ğŸ” Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ“¥ Pull source image
        run: |
          echo "ğŸ“¥ Pulling jiangrui1994/cloudsaver:${{ github.event.inputs.image_tag }}"
          docker pull jiangrui1994/cloudsaver:${{ github.event.inputs.image_tag }}
          
      - name: ğŸ·ï¸ Tag image for GitHub Packages
        run: |
          SOURCE_IMAGE="jiangrui1994/cloudsaver:${{ github.event.inputs.image_tag }}"
          TARGET_IMAGE="ghcr.io/${{ github.repository_owner }}/${{ github.event.inputs.registry_package_name }}:${{ github.event.inputs.image_tag }}"
          
          echo "ğŸ·ï¸ Tagging ${SOURCE_IMAGE} as ${TARGET_IMAGE}"
          docker tag ${SOURCE_IMAGE} ${TARGET_IMAGE}
          
          # åŒæ—¶åˆ›å»ºä¸€ä¸ªå¸¦æ—¶é—´æˆ³çš„ç‰ˆæœ¬
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          TIMESTAMPED_IMAGE="ghcr.io/${{ github.repository_owner }}/${{ github.event.inputs.registry_package_name }}:${TIMESTAMP}"
          echo "ğŸ·ï¸ Creating timestamped tag: ${TIMESTAMPED_IMAGE}"
          docker tag ${SOURCE_IMAGE} ${TIMESTAMPED_IMAGE}

      - name: ğŸš€ Push to GitHub Packages
        run: |
          TARGET_IMAGE="ghcr.io/${{ github.repository_owner }}/${{ github.event.inputs.registry_package_name }}:${{ github.event.inputs.image_tag }}"
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          TIMESTAMPED_IMAGE="ghcr.io/${{ github.repository_owner }}/${{ github.event.inputs.registry_package_name }}:${TIMESTAMP}"
          
          echo "ğŸš€ Pushing ${TARGET_IMAGE} to GitHub Packages"
          docker push ${TARGET_IMAGE}
          
          echo "ğŸš€ Pushing ${TIMESTAMPED_IMAGE} to GitHub Packages"
          docker push ${TIMESTAMPED_IMAGE}

      - name: ğŸ“‹ Verify published images
        run: |
          PACKAGE_NAME="${{ github.event.inputs.registry_package_name }}"
          REPO_OWNER="${{ github.repository_owner }}"
          
          echo "ğŸ” Verifying published images:"
          echo "----------------------------------------"
          echo "Latest tag: ghcr.io/${REPO_OWNER}/${PACKAGE_NAME}:latest"
          echo "Timestamped tag: ghcr.io/${REPO_OWNER}/${PACKAGE_NAME}:$(date +%Y%m%d-%H%M%S)"
          echo "----------------------------------------"
          
          # åˆ—å‡ºæœ¬åœ°é•œåƒç¡®è®¤
          docker images | grep "${PACKAGE_NAME}"

      - name: ğŸ“Š Summary
        if: always()
        run: |
          echo "===================================="
          echo "ğŸ³ DOCKER PUBLISH COMPLETED"
          echo "===================================="
          echo "Status: ${{ job.status }}"
          echo "Source: jiangrui1994/cloudsaver:${{ github.event.inputs.image_tag }}"
          echo "Package Name: ${{ github.event.inputs.registry_package_name }}"
          echo "Repository: ${{ github.repository }}"
          echo "Owner: ${{ github.repository_owner }}"
          echo "Published to: ghcr.io/${{ github.repository_owner }}/${{ github.event.inputs.registry_package_name }}"
          echo "Completion: $(date)"
          echo "===================================="
          
          echo ""
          echo "ğŸ“¥ To pull the image, use:"
          echo "docker pull ghcr.io/${{ github.repository_owner }}/${{ github.event.inputs.registry_package_name }}:${{ github.event.inputs.image_tag }}"