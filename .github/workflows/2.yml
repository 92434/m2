name: Enhanced Official Debug Session
on:
  workflow_dispatch:
    inputs:
      debug_duration:
        description: 'è°ƒè¯•ä¼šè¯æŒç»­æ—¶é—´ï¼ˆåˆ†é’Ÿï¼‰'
        required: false
        default: '15'
      debug_mode:
        description: 'è°ƒè¯•æ¨¡å¼'
        required: false
        default: 'interactive'
        type: choice
        options:
          - 'interactive'
          - 'detached'
      install_tools:
        description: 'å®‰è£…å¸¸ç”¨è°ƒè¯•å·¥å…·'
        required: false
        default: 'true'
        type: boolean
      custom_setup:
        description: 'è‡ªå®šä¹‰åˆå§‹åŒ–å‘½ä»¤'
        required: false
        default: ''
      enable_monitoring:
        description: 'å¯ç”¨ç³»ç»Ÿç›‘æŽ§'
        required: false
        default: 'false'
        type: boolean

env:
  DEBUG_TOOLS: "vim nano htop iotop net-tools dnsutils curl wget git build-essential python3 python3-pip"
  CUSTOM_SETUP: ${{ github.event.inputs.custom_setup }}
  ENABLE_MONITORING: ${{ github.event.inputs.enable_monitoring }}

jobs:
  prepare-debug:
    name: ðŸ› ï¸ Prepare Debug Environment
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: â±ï¸ Set timezone
        run: sudo timedatectl set-timezone "Asia/Shanghai"

      - name: ðŸ“¦ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“‹ System Information
        run: |
          echo "=== SYSTEM INFORMATION ==="
          echo "Hostname: $(hostname)"
          echo "OS: $(lsb_release -d | cut -f2)"
          echo "Kernel: $(uname -r)"
          echo "CPU Cores: $(nproc)"
          echo "Memory: $(free -h | grep Mem | awk '{print $2}')"
          echo "Disk Space: $(df -h / | tail -1 | awk '{print $4 " free"}')"
          echo "========================="

      - name: ðŸ› ï¸ Install Debug Tools
        if: github.event.inputs.install_tools == 'true'
        run: |
          echo "ðŸ“¥ Installing debug tools..."
          sudo apt-get update
          sudo apt-get install -y ${{ env.DEBUG_TOOLS }}
          echo "âœ… Debug tools installed"

      - name: ðŸ“‹ Execute Custom Setup
        if: env.CUSTOM_SETUP != ''
        run: |
          echo "ðŸ“‹ Running custom setup commands..."
          eval "${{ env.CUSTOM_SETUP }}"

  debug-session:
    name: ðŸ› Official tmate Debug Session
    needs: prepare-debug
    runs-on: ubuntu-latest
    timeout-minutes: ${{ fromJSON(github.event.inputs.debug_duration) + 15 }}

    steps:
      - name: ðŸ“¦ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“Š Pre-Session Diagnostics
        run: |
          echo "=== PRE-SESSION DIAGNOSTICS ==="
          echo "Timestamp: $(date)"
          echo "Available tools:"
          for tool in tmate vim nano htop curl git python3; do
            if command -v $tool &> /dev/null; then
              echo "  âœ… $tool ($( $tool --version 2>/dev/null | head -1))"
            else
              echo "  âŒ $tool"
            fi
          done
          echo "=============================="

      - name: Setup Official Debug Session
        uses: mxschmitt/action-tmate@v3
        timeout-minutes: ${{ fromJSON(github.event.inputs.debug_duration) }}
        with:
          detached: ${{ github.event.inputs.debug_mode == 'detached' }}
          limit-access-to-actor: true
          # å¯é€‰ï¼šä½¿ç”¨SSHå¯†é’¥æé«˜å®‰å…¨æ€§
          # ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: ðŸ“Š Session Completion Report
        if: always()
        run: |
          echo "===================================="
          echo "ðŸ› DEBUG SESSION REPORT"
          echo "===================================="
          echo "Session Status: ${{ job.status }}"
          echo "Duration: ${{ github.event.inputs.debug_duration }} minutes"
          echo "Mode: ${{ github.event.inputs.debug_mode }}"
          echo "Tools Installed: ${{ github.event.inputs.install_tools }}"
          echo "Custom Setup: ${{ github.event.inputs.custom_setup != '' }}"
          echo "Monitoring Enabled: ${{ env.ENABLE_MONITORING }}"
          echo "Runner: ${{ runner.name }}"
          echo "Workspace: ${{ github.workspace }}"
          echo "Completion Time: $(date)"
          echo "===================================="

  post-debug-analysis:
    name: ðŸ” Post-Debug Analysis
    needs: debug-session
    runs-on: ubuntu-latest
    if: failure() || github.event.inputs.enable_monitoring == 'true'

    steps:
      - name: ðŸ“¦ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ” System Analysis
        run: |
          echo "=== POST-DEBUG ANALYSIS ===" > analysis-report.txt
          echo "Session Result: ${{ needs.debug-session.result }}" >> analysis-report.txt
          echo "Analysis Time: $(date)" >> analysis-report.txt
          echo "" >> analysis-report.txt
          
          echo "=== SYSTEM STATE ===" >> analysis-report.txt
          uname -a >> analysis-report.txt
          echo "" >> analysis-report.txt
          
          echo "=== RESOURCE USAGE ===" >> analysis-report.txt
          free -h >> analysis-report.txt
          df -h >> analysis-report.txt
          echo "" >> analysis-report.txt
          
          echo "=== ACTIVE PROCESSES ===" >> analysis-report.txt
          ps aux --sort=-%cpu | head -15 >> analysis-report.txt
          echo "" >> analysis-report.txt
          
          echo "=== NETWORK CONNECTIONS ===" >> analysis-report.txt
          netstat -tuln >> analysis-report.txt
          
          cat analysis-report.txt

      - name: ðŸ“¤ Upload Analysis Report
        uses: actions/upload-artifact@v4
        with:
          name: debug-analysis-${{ github.run_number }}
          path: analysis-report.txt
          retention-days: 14
