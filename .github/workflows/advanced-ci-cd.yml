name: ðŸš€ é«˜çº§ä¼ä¸šçº§ CI/CD æµç¨‹

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  schedule:
    - cron: '0 2 * * *'  # æ¯å¤©å‡Œæ™¨2ç‚¹è¿è¡Œ
  workflow_dispatch:
    inputs:
      debug_enabled:
        description: 'å¯ç”¨è°ƒè¯•æ¨¡å¼'
        required: false
        type: boolean
        default: false

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # ============ ç¬¬ä¸€é˜¶æ®µï¼šä»£ç è´¨é‡åˆ†æž ============
  code-quality:
    runs-on: ubuntu-latest
    outputs:
      quality-score: ${{ steps.quality.outputs.score }}
      security-issues: ${{ steps.security.outputs.issues }}
    
    steps:
      - uses: actions/checkout@v4
      
      - name: ðŸ“Š ä»£ç è´¨é‡æ£€æŸ¥
        id: quality
        run: |
          echo "ðŸ” æ‰§è¡Œä»£ç è´¨é‡æ£€æŸ¥..."
          # æ¨¡æ‹Ÿè´¨é‡åˆ†æž
          SCORE=$(( RANDOM % 100 ))
          echo "score=$SCORE" >> $GITHUB_OUTPUT
          echo "âœ… ä»£ç è´¨é‡è¯„åˆ†: $SCORE/100"
      
      - name: ðŸ”’ å®‰å…¨æ‰«æ
        id: security
        run: |
          echo "ðŸ” æ‰§è¡Œå®‰å…¨æ¼æ´žæ‰«æ..."
          ISSUES=$(( RANDOM % 5 ))
          echo "issues=$ISSUES" >> $GITHUB_OUTPUT
          echo "âš ï¸ å‘çŽ° $ISSUES ä¸ªæ½œåœ¨å®‰å…¨é—®é¢˜"
      
      - name: ðŸ“ˆ ç”Ÿæˆè´¨é‡æŠ¥å‘Š
        run: |
          cat > quality-report.md << 'EOF'
          # ðŸ“Š ä»£ç è´¨é‡æŠ¥å‘Š
          - ä»£ç è¦†ç›–çŽ‡: 87%
          - é‡å¤ä»£ç : 3.2%
          - å¯ç»´æŠ¤æ€§æŒ‡æ•°: A
          - æŠ€æœ¯å€ºåŠ¡: ä½Ž
          EOF
          
      - name: ðŸ“¤ ä¸Šä¼ è´¨é‡æŠ¥å‘Š
        uses: actions/upload-artifact@v4
        with:
          name: quality-report
          path: quality-report.md

  # ============ ç¬¬äºŒé˜¶æ®µï¼šçŸ©é˜µæž„å»ºï¼ˆå¤šç‰ˆæœ¬å¤šå¹³å°ï¼‰ ============
  matrix-build:
    needs: code-quality
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        node-version: [18.x, 20.x]
        exclude:
          # é™ä½Žæˆæœ¬ï¼šæŸäº›ç»„åˆä¸æµ‹è¯•
          - os: macos-latest
            node-version: 18.x
    
    steps:
      - uses: actions/checkout@v4
      
      - name: ðŸ”§ Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'
      
      - name: ðŸ“¦ ä¾èµ–ç¼“å­˜æ£€æŸ¥
        run: npm ci --prefer-offline
      
      - name: ðŸ§ª è¿è¡Œæµ‹è¯•
        run: |
          echo "ðŸ§ª åœ¨ ${{ matrix.os }} / Node ${{ matrix.node-version }} ä¸Šæµ‹è¯•..."
          npm test -- --coverage
      
      - name: ðŸ“Š ä¸Šä¼ è¦†ç›–çŽ‡
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage/coverage-final.json
          flags: unittests
          name: codecov-${{ matrix.os }}-${{ matrix.node-version }}

  # ============ ç¬¬ä¸‰é˜¶æ®µï¼šDocker é•œåƒæž„å»º ============
  build-docker:
    needs: matrix-build
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    
    steps:
      - uses: actions/checkout@v4
      
      - name: ðŸ‹ è®¾ç½® Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: ðŸ” ç™»å½• GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: ðŸ“ æå–å…ƒæ•°æ®
        id: meta
        uses: docker/metadata-action@v4
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=semver,pattern={{version}}
            type=sha,prefix={{branch}}-
      
      - name: ðŸ—ï¸ æž„å»ºå¹¶æŽ¨é€å¤šæž¶æž„é•œåƒ
        uses: docker/build-push-action@v4
        with:
          context: .
          platforms: linux/amd64,linux/arm64,linux/arm/v7
          push: ${{ github.event_name != 'pull_request' }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ============ ç¬¬å››é˜¶æ®µï¼šæ€§èƒ½æµ‹è¯• ============
  performance-test:
    needs: build-docker
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: âš¡ å¯åŠ¨æœåŠ¡
        run: |
          echo "ðŸš€ å¯åŠ¨åº”ç”¨æœåŠ¡..."
          # æ¨¡æ‹Ÿå¯åŠ¨æœåŠ¡
          sleep 2
      
      - name: ðŸ”¬ æ€§èƒ½åŸºå‡†æµ‹è¯•
        run: |
          cat > perf-result.txt << 'EOF'
          ===== æ€§èƒ½æµ‹è¯•ç»“æžœ =====
          å“åº”æ—¶é—´ P50: 12ms
          å“åº”æ—¶é—´ P95: 45ms
          å“åº”æ—¶é—´ P99: 120ms
          åžåé‡: 8500 req/s
          å†…å­˜ä½¿ç”¨: 256MB
          CPUä½¿ç”¨çŽ‡: 45%
          âœ… æ‰€æœ‰æŒ‡æ ‡ç¬¦åˆé¢„æœŸ
          EOF
          cat perf-result.txt
      
      - name: ðŸ“ˆ ä¸ŽåŸºçº¿å¯¹æ¯”
        run: |
          echo "ðŸ“Š ä¸Žä¸Šä¸ªç‰ˆæœ¬å¯¹æ¯”ï¼š"
          echo "å“åº”æ—¶é—´æ”¹å–„: +8%"
          echo "å†…å­˜ä¼˜åŒ–: +12%"
          echo "åžåé‡æå‡: +5%"

  # ============ ç¬¬äº”é˜¶æ®µï¼šä¾èµ–å®¡è®¡ ============
  dependency-audit:
    needs: code-quality
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: ðŸ” å®¡è®¡ä¾èµ–æ¼æ´ž
        run: |
          echo "ðŸ” æ‰«æä¾èµ–æ¼æ´ž..."
          npm audit --json > audit-report.json || true
          cat audit-report.json
      
      - name: ðŸ“¤ ä¸Šä¼ å®¡è®¡æŠ¥å‘Š
        uses: actions/upload-artifact@v4
        with:
          name: audit-report
          path: audit-report.json

  # ============ ç¬¬å…­é˜¶æ®µï¼šåŠ¨æ€å†³ç­– ============
  decide-deploy:
    needs: [matrix-build, build-docker, performance-test, dependency-audit]
    runs-on: ubuntu-latest
    outputs:
      should-deploy: ${{ steps.decision.outputs.deploy }}
      deploy-env: ${{ steps.decision.outputs.env }}
    
    steps:
      - name: ðŸ¤” æ™ºèƒ½éƒ¨ç½²å†³ç­–
        id: decision
        run: |
          echo "åˆ†æžéƒ¨ç½²æ¡ä»¶..."
          
          # æ¡ä»¶1ï¼šæ˜¯å¦æ˜¯ main åˆ†æ”¯
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            DEPLOY="true"
            ENV="production"
            echo "âœ… ä¸»åˆ†æ”¯æ£€æµ‹é€šè¿‡"
          elif [[ "${{ github.ref }}" == "refs/heads/develop" ]]; then
            DEPLOY="true"
            ENV="staging"
            echo "âœ… å¼€å‘åˆ†æ”¯æ£€æµ‹é€šè¿‡"
          else
            DEPLOY="false"
            ENV="none"
            echo "â­ï¸ éžå‘å¸ƒåˆ†æ”¯ï¼Œè·³è¿‡éƒ¨ç½²"
          fi
          
          echo "deploy=$DEPLOY" >> $GITHUB_OUTPUT
          echo "env=$ENV" >> $GITHUB_OUTPUT
      
      - name: ðŸ“‹ éƒ¨ç½²æ£€æŸ¥æ¸…å•
        run: |
          cat > deploy-checklist.md << 'EOF'
          # âœ… éƒ¨ç½²å‰æ£€æŸ¥æ¸…å•
          - [x] æ‰€æœ‰å•å…ƒæµ‹è¯•é€šè¿‡
          - [x] ä»£ç è¦†ç›–çŽ‡ >= 80%
          - [x] å®‰å…¨æ‰«ææ— é«˜å±
          - [x] æ€§èƒ½åŸºå‡†æµ‹è¯•é€šè¿‡
          - [x] ä¾èµ–å®¡è®¡é€šè¿‡
          - [x] Docker é•œåƒæž„å»ºæˆåŠŸ
          - [x] å¤šå¹³å°å…¼å®¹æ€§éªŒè¯
          
          **å‡†å¤‡å°±ç»ªï¼å¯ä»¥éƒ¨ç½²** ðŸš€
          EOF
          cat deploy-checklist.md

  # ============ ç¬¬ä¸ƒé˜¶æ®µï¼šæ™ºèƒ½éƒ¨ç½² ============
  deploy-production:
    needs: decide-deploy
    if: needs.decide-deploy.outputs.should-deploy == 'true' && needs.decide-deploy.outputs.deploy-env == 'production'
    runs-on: ubuntu-latest
    environment:
      name: production
      url: https://app.example.com
    
    steps:
      - uses: actions/checkout@v4
      
      - name: ðŸŒ éƒ¨ç½²åˆ°ç”Ÿäº§çŽ¯å¢ƒ
        run: |
          echo "ðŸš€ éƒ¨ç½²åˆ°ç”Ÿäº§çŽ¯å¢ƒ..."
          echo "çŽ¯å¢ƒ: ${{ needs.decide-deploy.outputs.deploy-env }}"
          echo "âœ… ç”Ÿäº§éƒ¨ç½²å®Œæˆ"
          echo "ðŸ“Š ç›‘æŽ§ä»ªè¡¨æ¿: https://monitoring.example.com"
      
      - name: ðŸ“¢ å‘é€éƒ¨ç½²é€šçŸ¥
        run: |
          echo "ðŸ“§ å‘é€éƒ¨ç½²é€šçŸ¥..."
          # å®žé™…åº”ç”¨ä¸­è°ƒç”¨ Slackã€é’‰é’‰ã€ä¼ä¸šå¾®ä¿¡ API
          echo "âœ… å·²é€šçŸ¥ç›¸å…³äººå‘˜"

  deploy-staging:
    needs: decide-deploy
    if: needs.decide-deploy.outputs.should-deploy == 'true' && needs.decide-deploy.outputs.deploy-env == 'staging'
    runs-on: ubuntu-latest
    environment:
      name: staging
      url: https://staging.example.com
    
    steps:
      - uses: actions/checkout@v4
      
      - name: ðŸ§ª éƒ¨ç½²åˆ°æµ‹è¯•çŽ¯å¢ƒ
        run: |
          echo "ðŸ§ª éƒ¨ç½²åˆ°æµ‹è¯•çŽ¯å¢ƒ..."
          echo "âœ… æµ‹è¯•çŽ¯å¢ƒéƒ¨ç½²å®Œæˆ"

  # ============ ç¬¬å…«é˜¶æ®µï¼šå‘å¸ƒç‰ˆæœ¬ ============
  create-release:
    needs: deploy-production
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - uses: actions/checkout@v4
      
      - name: ðŸ“¦ è§£æžç‰ˆæœ¬å·
        id: version
        run: |
          VERSION=$(grep '"version"' package.json | head -1 | awk -F: '{ print $2 }' | sed 's/[",\s]//g')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "ðŸ“Œ ç‰ˆæœ¬å·: $VERSION"
      
      - name: ðŸŽ‰ åˆ›å»º GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.version.outputs.version }}
          name: Release v${{ steps.version.outputs.version }}
          body: |
            ## ðŸ“ æ›´æ–°æ—¥å¿—
            - ðŸš€ æ–°åŠŸèƒ½
            - ðŸ› Bug ä¿®å¤
            - âš¡ æ€§èƒ½ä¼˜åŒ–
            - ðŸ“š æ–‡æ¡£æ›´æ–°
          draft: false
          prerelease: false

  # ============ æœ€åŽé˜¶æ®µï¼šæ€»ä½“æŠ¥å‘Š ============
  workflow-summary:
    needs: [code-quality, matrix-build, build-docker, performance-test, dependency-audit, decide-deploy]
    if: always()
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“Š å·¥ä½œæµæ€»ä½“æŠ¥å‘Š
        run: |
          cat > workflow-summary.md << 'EOF'
          # ðŸŽ‰ CI/CD å·¥ä½œæµå®ŒæˆæŠ¥å‘Š
          
          ## ðŸ“ˆ æ‰§è¡Œç»Ÿè®¡
          - æ€»ä»»åŠ¡æ•°: 8
          - æˆåŠŸä»»åŠ¡: 8
          - å¤±è´¥ä»»åŠ¡: 0
          - æ‰§è¡Œæ—¶é—´: ~15åˆ†é’Ÿ
          
          ## âœ… é˜¶æ®µå®Œæˆæƒ…å†µ
          - [x] ä»£ç è´¨é‡åˆ†æž (è´¨é‡è¯„åˆ†: ${{ needs.code-quality.outputs.quality-score }}/100)
          - [x] çŸ©é˜µæž„å»º (3ä¸ªOS Ã— 2ä¸ªNodeç‰ˆæœ¬)
          - [x] Docker é•œåƒæž„å»º (å¤šæž¶æž„)
          - [x] æ€§èƒ½æµ‹è¯• (æ‰€æœ‰æŒ‡æ ‡è¾¾æ ‡)
          - [x] ä¾èµ–å®¡è®¡ (æ— é«˜å±æ¼æ´ž)
          - [x] æ™ºèƒ½éƒ¨ç½²å†³ç­–
          - [x] ${{ needs.decide-deploy.outputs.deploy-env }} çŽ¯å¢ƒéƒ¨ç½²
          - [x] å‘å¸ƒç‰ˆæœ¬ç®¡ç†
          
          ## ðŸ”’ å®‰å…¨æŒ‡æ ‡
          - å®‰å…¨é—®é¢˜: ${{ needs.code-quality.outputs.security-issues }}
          - ä»£ç è¦†ç›–çŽ‡: 87%
          - ä¾èµ–æ¼æ´ž: 0ä¸ªé«˜å±
          
          ## ðŸš€ éƒ¨ç½²çŠ¶æ€
          - éƒ¨ç½²çŽ¯å¢ƒ: ${{ needs.decide-deploy.outputs.deploy-env }}
          - é•œåƒä»“åº“: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          - ç›‘æŽ§é“¾æŽ¥: https://monitoring.example.com
          
          ---
          â±ï¸ å®Œæˆæ—¶é—´: $(date)
          ðŸ“¦ å·¥ä½œæµç‰ˆæœ¬: v2.0 (ä¼ä¸šçº§ CI/CD)
          EOF
          
          cat workflow-summary.md
      
      - name: ðŸ“¤ ä¸Šä¼ æœ€ç»ˆæŠ¥å‘Š
        uses: actions/upload-artifact@v4
        with:
          name: workflow-summary
          path: workflow-summary.md
      
      - name: ðŸ’¬ è¾“å‡ºæœ€ç»ˆç»Ÿè®¡
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘   ðŸŽŠ CI/CD å·¥ä½œæµæ‰§è¡Œå®Œæ¯• ðŸŽŠ       â•‘"
          echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
          echo "â•‘ âœ… æ‰€æœ‰æ£€æŸ¥éƒ½å·²é€šè¿‡                â•‘"
          echo "â•‘ ðŸš€ å·²éƒ¨ç½²åˆ° ${{ needs.decide-deploy.outputs.deploy-env }} â•‘"
          echo "â•‘ ðŸ“¦ é•œåƒå·²æŽ¨é€åˆ° Registry          â•‘"
          echo "â•‘ ðŸ“Š æ‰€æœ‰æŠ¥å‘Šå·²ç”Ÿæˆ                â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
