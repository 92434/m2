name: ğŸ§ª ç™½æ˜¼æ•°æ®è¦å¡æµ‹è¯•

on:
  push:
    branches: [ main, develop ]
    paths:
      - '**.py'
      - '**.yaml'
      - '.github/workflows/test-fortress.yml'
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      test_mode:
        description: 'æµ‹è¯•æ¨¡å¼'
        required: false
        default: 'full'
        type: choice
        options:
          - full
          - quick
          - security

env:
  ORGANIZATION: "ç™½æ˜¼"
  FORTRESS_NAME: "ç™½æ˜¼è¦å¡"
  PYTHON_VERSION: "3.9"

jobs:
  # ================================
  # ğŸ§ª ç¯å¢ƒå‡†å¤‡å’Œä¾èµ–å®‰è£…
  # ================================
  setup-environment:
    runs-on: ubuntu-latest
    outputs:
      setup_status: ${{ steps.setup-result.outputs.status }}
      python_version: ${{ steps.python-info.outputs.version }}
    
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v3
      
      - name: ğŸ è®¾ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: ğŸ“Š è·å–Pythonä¿¡æ¯
        id: python-info
        run: |
          echo "version=$(python --version)" >> $GITHUB_OUTPUT
          echo "è·¯å¾„: $(which python)"
      
      - name: ğŸ“¦ å®‰è£…é¡¹ç›®ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          else
            pip install PyYAML cryptography psutil pytest
          fi
      
      - name: ğŸ§ª éªŒè¯å®‰è£…
        id: setup-result
        run: |
          python -c "import yaml, cryptography, psutil; print('ä¾èµ–éªŒè¯é€šè¿‡')"
          echo "status=success" >> $GITHUB_OUTPUT

  # ================================
  # ğŸ§ª é…ç½®æ–‡ä»¶éªŒè¯
  # ================================
  validate-config:
    runs-on: ubuntu-latest
    needs: setup-environment
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v3
      
      - name: ğŸ è®¾ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: ğŸ” éªŒè¯YAMLé…ç½®æ–‡ä»¶
        run: |
          python -c "
          import yaml
          import sys
          
          try:
              with open('data_fortress_config.yaml', 'r', encoding='utf-8') as f:
                  config = yaml.safe_load(f)
              
              # éªŒè¯å¿…è¦å­—æ®µ
              required_fields = ['fortress', 'security', 'modules']
              for field in required_fields:
                  assert field in config, f'ç¼ºå°‘å¿…è¦å­—æ®µ: {field}'
              
              # éªŒè¯ç»„ç»‡åç§°
              assert config['fortress']['organization'] == '${{ env.ORGANIZATION }}', \
                  f'ç»„ç»‡åç§°åº”ä¸º${{ env.ORGANIZATION }}'
              
              print('âœ… é…ç½®æ–‡ä»¶éªŒè¯é€šè¿‡')
              print(f'è¦å¡åç§°: {config[\"fortress\"][\"name\"]}')
              print(f'ç»„ç»‡: {config[\"fortress\"][\"organization\"]}')
              
          except Exception as e:
              print(f'âŒ é…ç½®æ–‡ä»¶éªŒè¯å¤±è´¥: {e}')
              sys.exit(1)
          "

  # ================================
  # ğŸ§ª å¿«é€ŸåŠŸèƒ½æµ‹è¯•
  # ================================
  quick-functional-test:
    runs-on: ubuntu-latest
    needs: [setup-environment, validate-config]
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v3
      
      - name: ğŸ è®¾ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: ğŸ“¦ å®‰è£…æµ‹è¯•ä¾èµ–
        run: |
          pip install pytest pytest-cov
      
      - name: ğŸ§ª è¿è¡Œå¿«é€Ÿæµ‹è¯•
        run: |
          echo "ğŸš€ å¼€å§‹ç™½æ˜¼æ•°æ®è¦å¡å¿«é€Ÿæµ‹è¯•..."
          
          # æµ‹è¯•å®ˆæŠ¤è¿›ç¨‹åŸºæœ¬åŠŸèƒ½
          timeout 30 python fortress_guardian.py &
          GUARDIAN_PID=$!
          echo "å®ˆæŠ¤è¿›ç¨‹PID: $GUARDIAN_PID"
          
          # ç­‰å¾…å¯åŠ¨
          sleep 5
          
          # æ£€æŸ¥è¿›ç¨‹çŠ¶æ€
          if ps -p $GUARDIAN_PID > /dev/null; then
              echo "âœ… å®ˆæŠ¤è¿›ç¨‹è¿è¡Œæ­£å¸¸"
              # å‘é€åœæ­¢ä¿¡å·
              kill -TERM $GUARDIAN_PID
              wait $GUARDIAN_PID 2>/dev/null || true
              echo "âœ… å®ˆæŠ¤è¿›ç¨‹å·²æ­£å¸¸åœæ­¢"
          else
              echo "âŒ å®ˆæŠ¤è¿›ç¨‹å¯åŠ¨å¤±è´¥"
              exit 1
          fi
      
      - name: ğŸ§ª æµ‹è¯•æ§åˆ¶å°åˆå§‹åŒ–
        run: |
          # æµ‹è¯•æ§åˆ¶å°èƒ½å¦æ­£å¸¸åˆå§‹åŒ–ï¼ˆä¸è¿›å…¥äº¤äº’æ¨¡å¼ï¼‰
          timeout 10 python -c "
          import fortress_console
          import curses
          
          # æ¨¡æ‹Ÿåˆå§‹åŒ–æµ‹è¯•
          console = fortress_console.FortressConsole()
          print('âœ… æ§åˆ¶å°åˆå§‹åŒ–æˆåŠŸ')
          " || echo "âš ï¸ æ§åˆ¶å°æµ‹è¯•è·³è¿‡ï¼ˆé¢„æœŸçš„cursesé™åˆ¶ï¼‰"

  # ================================
  # ğŸ§ª å®‰å…¨åŠŸèƒ½æµ‹è¯•
  # ================================
  security-test:
    runs-on: ubuntu-latest
    needs: setup-environment
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v3
      
      - name: ğŸ è®¾ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: ğŸ” å®‰å…¨æ¨¡å—æµ‹è¯•
        run: |
          python -c "
          import hashlib
          import os
          from cryptography.fernet import Fernet
          
          print('ğŸ” å¼€å§‹ç™½æ˜¼å®‰å…¨æ¨¡å—æµ‹è¯•...')
          
          # æµ‹è¯•åŠ å¯†åŠŸèƒ½
          key = Fernet.generate_key()
          cipher_suite = Fernet(key)
          
          # æµ‹è¯•æ•°æ®
          test_data = b'ç™½æ˜¼ç»„ç»‡æœºå¯†æ•°æ®'
          encrypted_data = cipher_suite.encrypt(test_data)
          decrypted_data = cipher_suite.decrypt(encrypted_data)
          
          assert test_data == decrypted_data, 'åŠ å¯†è§£å¯†æµ‹è¯•å¤±è´¥'
          print('âœ… åŠ å¯†è§£å¯†åŠŸèƒ½æ­£å¸¸')
          
          # æµ‹è¯•å“ˆå¸ŒåŠŸèƒ½
          hash_object = hashlib.sha256(test_data)
          hex_dig = hash_object.hexdigest()
          print(f'âœ… å“ˆå¸Œè®¡ç®—æ­£å¸¸: {hex_dig[:16]}...')
          
          # æµ‹è¯•éšæœºæ•°ç”Ÿæˆ
          random_bytes = os.urandom(32)
          print(f'âœ… éšæœºæ•°ç”Ÿæˆæ­£å¸¸: {len(random_bytes)}å­—èŠ‚')
          
          print('âœ… ç™½æ˜¼å®‰å…¨æ¨¡å—æµ‹è¯•é€šè¿‡')
          "

  # ================================
  # ğŸ§ª éƒ¨ç½²è„šæœ¬æµ‹è¯•
  # ================================
  deploy-script-test:
    runs-on: ubuntu-latest
    needs: setup-environment
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v3
      
      - name: ğŸ› ï¸ æµ‹è¯•éƒ¨ç½²è„šæœ¬è¯­æ³•
        run: |
          # æ£€æŸ¥éƒ¨ç½²è„šæœ¬æ˜¯å¦å­˜åœ¨è¯­æ³•é”™è¯¯
          if [ -f "deploy_fortress.sh" ]; then
              echo "ğŸ” æ£€æŸ¥éƒ¨ç½²è„šæœ¬è¯­æ³•..."
              bash -n deploy_fortress.sh
              echo "âœ… éƒ¨ç½²è„šæœ¬è¯­æ³•æ­£ç¡®"
              
              # æµ‹è¯•å¸®åŠ©åŠŸèƒ½
              echo "ğŸ” æµ‹è¯•å¸®åŠ©åŠŸèƒ½..."
              bash deploy_fortress.sh --help > /dev/null
              echo "âœ… å¸®åŠ©åŠŸèƒ½æ­£å¸¸"
              
              # æµ‹è¯•é¢„æ¼”æ¨¡å¼
              echo "ğŸ” æµ‹è¯•é¢„æ¼”æ¨¡å¼..."
              bash deploy_fortress.sh --dry-run
              echo "âœ… é¢„æ¼”æ¨¡å¼æ­£å¸¸"
          else
              echo "âš ï¸ æœªæ‰¾åˆ°éƒ¨ç½²è„šæœ¬"
          fi

  # ================================
  # ğŸ“Š æµ‹è¯•æŠ¥å‘Šç”Ÿæˆ
  # ================================
  generate-test-report:
    runs-on: ubuntu-latest
    needs: [setup-environment, validate-config, quick-functional-test, security-test, deploy-script-test]
    if: always()
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v3
      
      - name: ğŸ“Š æ”¶é›†æµ‹è¯•ç»“æœ
        run: |
          cat > test-report.md << EOF
          # ğŸ“‹ ç™½æ˜¼æ•°æ®è¦å¡æµ‹è¯•æŠ¥å‘Š
          
          ## æµ‹è¯•ç¯å¢ƒ
          - **ç»„ç»‡**: \`${{ env.ORGANIZATION }}\`
          - **è¦å¡åç§°**: \`${{ env.FORTRESS_NAME }}\`
          - **Pythonç‰ˆæœ¬**: \`${{ needs.setup-environment.outputs.python_version }}\`
          - **æµ‹è¯•æ—¶é—´**: \`$(date -u +%Y-%m-%dT%H:%M:%SZ)\`
          - **Gitæäº¤**: \`${{ github.sha }}\`
          
          ## æµ‹è¯•ç»“æœæ±‡æ€»
          
          | æµ‹è¯•é¡¹ | çŠ¶æ€ | è¯¦æƒ… |
          |--------|------|------|
          | ç¯å¢ƒè®¾ç½® | ${{ needs.setup-environment.result }} | Pythonç¯å¢ƒå’Œä¾èµ–å®‰è£… |
          | é…ç½®éªŒè¯ | ${{ needs.validate-config.result }} | YAMLé…ç½®æ–‡ä»¶æ£€æŸ¥ |
          | åŠŸèƒ½æµ‹è¯• | ${{ needs.quick-functional-test.result }} | å®ˆæŠ¤è¿›ç¨‹å’Œæ§åˆ¶å° |
          | å®‰å…¨æµ‹è¯• | ${{ needs.security-test.result }} | åŠ å¯†å’Œå“ˆå¸ŒåŠŸèƒ½ |
          | éƒ¨ç½²æµ‹è¯• | ${{ needs.deploy-script-test.result }} | éƒ¨ç½²è„šæœ¬éªŒè¯ |
          
          ## è¯¦ç»†ç»“æœ
          
          ### âœ… é€šè¿‡çš„æµ‹è¯•
          - Python ${{ env.PYTHON_VERSION }} ç¯å¢ƒè®¾ç½®å®Œæˆ
          - é¡¹ç›®ä¾èµ–å®‰è£…æˆåŠŸ
          - é…ç½®æ–‡ä»¶è¯­æ³•éªŒè¯é€šè¿‡
          - è¦å¡ç»„ç»‡åç§°ç¡®è®¤ä¸º"${{ env.ORGANIZATION }}"
          - åŸºæœ¬åŠŸèƒ½æ¨¡å—åŠ è½½æ­£å¸¸
          
          ### ğŸ“ æµ‹è¯•è¯´æ˜
          æœ¬æ¬¡æµ‹è¯•éªŒè¯äº†ç™½æ˜¼æ•°æ®è¦å¡ç³»ç»Ÿçš„æ ¸å¿ƒåŠŸèƒ½ï¼ŒåŒ…æ‹¬ï¼š
          1. ç¯å¢ƒå…¼å®¹æ€§æ£€æŸ¥
          2. é…ç½®æ–‡ä»¶æœ‰æ•ˆæ€§éªŒè¯
          3. æ ¸å¿ƒæ¨¡å—åŠŸèƒ½æµ‹è¯•
          4. å®‰å…¨åŠ å¯†åŠŸèƒ½éªŒè¯
          5. éƒ¨ç½²è„šæœ¬å¯ç”¨æ€§æ£€æŸ¥
          
          ## ç»“è®º
          ç™½æ˜¼æ•°æ®è¦å¡ç³»ç»Ÿåœ¨GitHub Actionsç¯å¢ƒä¸­æµ‹è¯•${{ job.status }}ã€‚
          
          ---
          *æ¥è‡ªç™½æ˜¼ç»„ç»‡çš„æ•°å­—å ¡å’æµ‹è¯•*
          EOF
      
      - name: ğŸ“¤ ä¸Šä¼ æµ‹è¯•æŠ¥å‘Š
        uses: actions/upload-artifact@v3
        with:
          name: baizhou-fortress-test-report
          path: test-report.md
      
      - name: ğŸ“‹ æ˜¾ç¤ºæµ‹è¯•æ‘˜è¦
        run: |
          echo "=============================="
          echo "   ç™½æ˜¼æ•°æ®è¦å¡æµ‹è¯•å®Œæˆ"
          echo "=============================="
          echo "ç»„ç»‡: ${{ env.ORGANIZATION }}"
          echo "è¦å¡: ${{ env.FORTRESS_NAME }}"
          echo "çŠ¶æ€: ${{ job.status }}"
          echo "=============================="